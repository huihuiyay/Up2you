# Complete Fix for Alpha Channel Error
# Apply this patch to: /share/mas/huangping/yuzihui/up2you/inference_thg.py

# ============================================
# Location: Around line 294-330 (Stage 5: 生成法线图)
# ============================================

# FIND THIS CODE (the old broken version):
# -----------------------------------------------
# with torch.no_grad():
#     images_tensor = rearrange(
#         torch.stack([load_image(image, 768, 768) for image in images_rgba]),
#         "Nv H W C -> Nv C H W"
#     ).to(device)
#
#     normals = normal_pipe(
#         prompt=["Multi-view Human, Full Body, Normal Map, High Quality, HDR"],
#         reference_rgbs=images_tensor,
#         control_image=target_poses,
#         ...
# -----------------------------------------------

# REPLACE WITH THIS CODE:
# -----------------------------------------------
with torch.no_grad():
    # 转换RGB为tensor（用于法线生成）
    # 注意：load_image不带return_alpha参数时返回HWC格式（无alpha）
    mv_rgbs = []
    for image_rgba in images_rgba:
        mv_rgbs.append(load_image(image_rgba, 768, 768))
    mv_rgbs = torch.stack(mv_rgbs)
    mv_rgbs = mv_rgbs.permute(0, 3, 1, 2).to(device)

    normals = normal_pipe(
        prompt=["Multi-view Human, Full Body, Normal Map, High Quality, HDR"],
        reference_rgbs=mv_rgbs,  # 使用mv_rgbs而非images_tensor
        control_image=target_poses,
        weight_maps=weight_maps,
        num_images_per_prompt=20,
        generator=torch.Generator(device=device).manual_seed(args.seed),
        num_inference_steps=args.num_inference_steps,
        guidance_scale=args.guidance_scale,
        height=768,
        width=768,
    ).images
# -----------------------------------------------

# ============================================
# COMPLETE SECTION (lines 288-345 approximately)
# ============================================

    # ============ Stage 5: 生成法线图 ============
    print(f"[5/8] 生成法线图 (20视角, THG间隔={args.thg_interval})...")

    # 加载法线生成模型
    from up2you.pipelines.pipeline_mvpuzzle_mv2normal_sd21 import UP2YouMV2NormalSDPipeline

    normal_pipe = UP2YouMV2NormalSDPipeline.from_pretrained(
        args.base_model_path,
        safety_checker=None,
        torch_dtype=dtype,
    ).to(device)

    # 配置THG调度器（法线生成）
    from up2you.schedulers.scheduling_shift_snr import ShiftSNRScheduler
    from diffusers import DDPMScheduler

    base_scheduler = ShiftSNRScheduler.from_scheduler(
        normal_pipe.scheduler,
        shift_mode="interpolated",
        shift_scale=8.0,
        scheduler_class=DDPMScheduler,
    )

    normal_pipe.scheduler = TortoiseHareGuidanceScheduler.from_scheduler(
        base_scheduler,
        guidance_update_interval=args.thg_interval,
    )

    # 加载法线适配器
    normal_pipe.load_custom_adapter(args.normal_adapter_path)
    normal_pipe.init_custom_adapter(num_views=20, mode='topk')

    # FP16优化
    normal_pipe.to(device=device, dtype=dtype)
    normal_pipe.cond_encoder.to(device=device, dtype=dtype)
    normal_pipe.enable_vae_slicing()

    # 转换RGB为tensor（用于法线生成）
    # 注意：load_image不带return_alpha参数时返回HWC格式（无alpha）
    mv_rgbs = []
    for image_rgba in images_rgba:
        mv_rgbs.append(load_image(image_rgba, 768, 768))
    mv_rgbs = torch.stack(mv_rgbs)
    mv_rgbs = mv_rgbs.permute(0, 3, 1, 2).to(device)

    # 生成法线图（使用THG加速）
    with torch.no_grad():
        normals = normal_pipe(
            prompt=["Multi-view Human, Full Body, Normal Map, High Quality, HDR"],
            reference_rgbs=mv_rgbs,
            control_image=target_poses,
            weight_maps=weight_maps,
            num_images_per_prompt=20,
            generator=torch.Generator(device=device).manual_seed(args.seed),
            num_inference_steps=args.num_inference_steps,
            guidance_scale=args.guidance_scale,
            height=768,
            width=768,
        ).images

    # THG统计信息（法线生成）
    stats = normal_pipe.scheduler.get_statistics()
    print(f"THG统计 (法线):")
    print(f"  总NFE: {stats['total_nfe']}")
    print(f"  节省NFE: {stats['saved_nfe']}")
    print(f"  效率提升: {stats['efficiency']:.1%}")

    # 保存法线图
    normal_dir = output_dir / "normal"
    normal_dir.mkdir(exist_ok=True)
    for idx, normal in enumerate(normals):
        normal.save(normal_dir / f"{idx:03d}.png")

    print(f"✓ 法线图已保存至 {normal_dir}")

    # 清理显存
    del normal_pipe
    torch.cuda.empty_cache()

# ============================================
# End of patch
# ============================================

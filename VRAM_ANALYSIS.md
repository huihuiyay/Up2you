# UP2You æ˜¾å­˜å ç”¨è¯¦ç»†åˆ†æ

## å½“å‰é…ç½®ï¼ˆä»æ—¥å¿—åˆ†æï¼‰

**ç¡¬ä»¶**: NVIDIA GeForce RTX 4090 (24GB)
**é…ç½®**: 20è§†è§’, 768Ã—768åˆ†è¾¨ç‡, FP16, THGé—´éš”=3

**å®é™…è¿è¡ŒçŠ¶æ€**: âœ… æˆåŠŸå®Œæˆï¼Œæ— OOM

---

## å„é˜¶æ®µå®é™…æ˜¾å­˜ä½¿ç”¨åˆ†æ

### é˜¶æ®µ1: èƒŒæ™¯åˆ†å‰² (~0.8 GB)
- BiRefNetæ¨¡å‹: ~260MB (FP16)
- è¾“å…¥å›¾åƒç¼“å­˜: ~100MB
- ä¸­é—´æ¿€æ´»: ~400MB
- **å³°å€¼**: ~0.8GB

### é˜¶æ®µ2-3: ç‰¹å¾æå– + å½¢çŠ¶é¢„æµ‹ (~2.5 GB)
- DINOv2-ViT-L/14: ~600MB (FP16)
- ShapePredictor: ~100MB
- ç‰¹å¾ç¼“å­˜ (å¤šå¼ å‚è€ƒå›¾): ~1.5GB
- ä¸­é—´æ¿€æ´»: ~300MB
- **å³°å€¼**: ~2.5GB

### é˜¶æ®µ4: A-Poseç”Ÿæˆ (~1.5 GB)
- SMPL-Xæ¨¡å‹: ~50MB
- AposeRenderer: ~200MB
- 20ä¸ªposeå›¾åƒç¼“å­˜: ~1GB (20 Ã— 3 Ã— 768 Ã— 768 Ã— FP16)
- **å³°å€¼**: ~1.5GB

### é˜¶æ®µ5: æƒé‡å›¾ç”Ÿæˆ (~2.0 GB)
- FeatureAggregator: ~200MB
- Poseç‰¹å¾: ~800MB
- Refç‰¹å¾: ~500MB
- æƒé‡å›¾è¾“å‡º: ~300MB
- ä¸­é—´æ¿€æ´»: ~200MB
- **å³°å€¼**: ~2.0GB

### é˜¶æ®µ6: RGBç”Ÿæˆ - **å³°å€¼é˜¶æ®µ** (~14-18 GB)

#### æ¨¡å‹æƒé‡
- SD 2.1 UNet: ~1.7GB (FP16)
- SD 2.1 VAE: ~166MB (FP16)
- SD 2.1 Text Encoder: ~246MB (FP16)
- CustomAdapter: ~40MB (FP16)
- **å°è®¡**: ~2.15GB

#### æ¨ç†ä¸­é—´æ¿€æ´»ï¼ˆTHGä¼˜åŒ–ï¼‰

**æ ‡å‡†CFGæ¨¡å¼** (æ— THG):
- Latentè¾“å…¥: 2 Ã— [1, 4, 96, 96] = 2 Ã— 144KB â‰ˆ 0.3MB
- UNetç¼–ç å™¨æ¿€æ´»:
  - Down blocks (4å±‚): ~8GB
  - Mid block: ~2GB
  - Up blocks (4å±‚): ~4GB
- Attentionç¼“å­˜: ~1GB
- **CFGåŒbatchå³°å€¼**: ~15GB

**THGä¼˜åŒ–æ¨¡å¼**:
- æ›´æ–°guidanceæ­¥éª¤ (17æ­¥): åŒæ ‡å‡†CFG, ~15GB
- è·³è¿‡guidanceæ­¥éª¤ (33æ­¥): åªè¿è¡Œcondåˆ†æ”¯, ~8GB
- **å³°å€¼ä»ä¸º**: ~15GBï¼ˆåœ¨æ›´æ–°æ­¥éª¤ï¼‰
- **å¹³å‡**: (17Ã—15 + 33Ã—8) / 50 â‰ˆ 10.3GB

#### Adapterç›¸å…³
- ref_hidden_statesç¼“å­˜: ~1.5GB
- weight_maps: ~300MB
- down_intrablock_residuals: ~500MB
- **å°è®¡**: ~2.3GB

#### VAEè§£ç  (20å¼ 768Ã—768å›¾åƒ)
- è¾“å…¥latents: 20 Ã— [1, 4, 96, 96] Ã— FP16 â‰ˆ 1.4MB
- VAEè§£ç å™¨æ¿€æ´» (æ‰¹é‡): ~2GB
- è¾“å‡ºRGBå›¾åƒ: 20 Ã— 3 Ã— 768 Ã— 768 Ã— FP16 â‰ˆ 70MB
- **å°è®¡**: ~2.1GB

#### **é˜¶æ®µ6æ€»å³°å€¼**: 2.15 + 15 + 2.3 + 2.1 â‰ˆ **21.5 GB**
- THGå¹³å‡: 2.15 + 10.3 + 2.3 + 2.1 â‰ˆ **17 GB**

### é˜¶æ®µ7: æ³•çº¿ç”Ÿæˆ (~14-18 GB)
- ä¸é˜¶æ®µ6ç›¸åŒçš„pipeline
- **å³°å€¼**: ~21.5GB

### é˜¶æ®µ8: ç½‘æ ¼é‡å»º (~8 GB)
- RGBå›¾åƒ (20 Ã— 768Ã—768): ~70MB
- æ³•çº¿å›¾åƒ (20 Ã— 768Ã—768): ~70MB
- SMPLç½‘æ ¼: ~10MB
- FlexiCubesé‡å»º:
  - ç½‘æ ¼é¡¶ç‚¹/é¢ç‰‡: ~500MB
  - ä¼˜åŒ–å™¨çŠ¶æ€: ~3GB
  - æ¸²æŸ“ä¸­é—´ç»“æœ: ~4GB
- **å³°å€¼**: ~8GB

### é˜¶æ®µ9: è§†é¢‘æ¸²æŸ“ (~3 GB)
- CommonRenderer: ~200MB
- æ¸²æŸ“ç¼“å†²åŒº: ~2GB
- è¾“å‡ºè§†é¢‘å¸§: ~800MB
- **å³°å€¼**: ~3GB

---

## æ€»ä½“å³°å€¼æ˜¾å­˜

| é˜¶æ®µ | å³°å€¼æ˜¾å­˜ | å‘ç”Ÿæ—¶æœº |
|------|---------|---------|
| 1. èƒŒæ™¯åˆ†å‰² | 0.8 GB | - |
| 2-3. ç‰¹å¾+å½¢çŠ¶ | 2.5 GB | - |
| 4. A-Pose | 1.5 GB | - |
| 5. æƒé‡å›¾ | 2.0 GB | - |
| **6. RGBç”Ÿæˆ** | **21.5 GB** | **UNetå‰å‘ä¼ æ’­ï¼ˆCFGæ›´æ–°æ­¥éª¤ï¼‰** |
| **7. æ³•çº¿ç”Ÿæˆ** | **21.5 GB** | **UNetå‰å‘ä¼ æ’­ï¼ˆCFGæ›´æ–°æ­¥éª¤ï¼‰** |
| 8. ç½‘æ ¼é‡å»º | 8.0 GB | FlexiCubesä¼˜åŒ– |
| 9. è§†é¢‘æ¸²æŸ“ | 3.0 GB | - |

**å…¨å±€å³°å€¼**: **21.5 GB** (é˜¶æ®µ6æˆ–7çš„UNetå‰å‘ä¼ æ’­)

---

## æ˜¾å­˜å ç”¨å› ç´ åˆ†æ

### ä¸»è¦æ˜¾å­˜æ¶ˆè€—ï¼ˆæŒ‰é‡è¦æ€§æ’åºï¼‰

1. **UNetæ¿€æ´»å€¼** (~15GB, 70%)
   - å—åˆ†è¾¨ç‡å½±å“: âˆ (resolution/8)Â²
   - å—CFGå½±å“: åŒbatch
   - THGå¯é™ä½å¹³å‡å€¼ï¼Œä½†å³°å€¼ä¸å˜

2. **Adapterç¼“å­˜** (~2.3GB, 11%)
   - å—è§†è§’æ•°å½±å“: âˆ num_views
   - åŒ…å«ref_hidden_states

3. **æ¨¡å‹æƒé‡** (~2.2GB, 10%)
   - å›ºå®šå¼€é”€
   - FP16å¯å‡åŠ

4. **VAEè§£ç ** (~2.1GB, 10%)
   - å—è§†è§’æ•°å’Œåˆ†è¾¨ç‡å½±å“
   - æ‰¹é‡è§£ç èŠ‚çœæ˜¾å­˜

5. **å…¶ä»–** (~2GB, 9%)
   - ç‰¹å¾ç¼“å­˜ã€ä¸´æ—¶å˜é‡ç­‰

### æ˜¾å­˜èŠ‚çœç­–ç•¥

| ç­–ç•¥ | èŠ‚çœé‡ | å‰¯ä½œç”¨ |
|------|--------|--------|
| ä½¿ç”¨FP16 | ~50% | ç²¾åº¦è½»å¾®ä¸‹é™ï¼ˆå¯å¿½ç•¥ï¼‰ |
| THG (interval=3) | å¹³å‡~30% | å³°å€¼ä¸å˜ï¼Œé€Ÿåº¦æå‡1.5Ã— |
| VAE Slicing | ~20% | è§£ç é€Ÿåº¦ç¨æ…¢ |
| å‡å°‘è§†è§’æ•° (20â†’12) | ~15% | 3Dè´¨é‡å¯èƒ½ä¸‹é™ |
| é™ä½åˆ†è¾¨ç‡ (768â†’512) | ~50% | å›¾åƒè´¨é‡æ˜æ˜¾ä¸‹é™ |
| Gradient Checkpointing | ~40% | é€Ÿåº¦é™ä½1.3-1.5Ã— |

---

## ä¸åŒæ˜¾å¡çš„é€‚é…æ€§

### RTX 4090 (24GB) - **ä½ å½“å‰çš„æ˜¾å¡** âœ…
- **20è§†è§’, 768åˆ†è¾¨ç‡, FP16**: âœ… å®Œå…¨å¤Ÿç”¨ (21.5/24 = 90%åˆ©ç”¨ç‡)
- **20è§†è§’, 1024åˆ†è¾¨ç‡, FP16**: âš ï¸ å¯èƒ½OOM (~32GBéœ€æ±‚)
- **30è§†è§’, 768åˆ†è¾¨ç‡, FP16**: âš ï¸ è¾¹ç•Œæƒ…å†µ (~23GB)

### RTX 3090 (24GB)
- **20è§†è§’, 768åˆ†è¾¨ç‡, FP16**: âœ… å¯ç”¨
- **20è§†è§’, 1024åˆ†è¾¨ç‡, FP16**: âŒ OOM

### RTX 4080 (16GB)
- **20è§†è§’, 768åˆ†è¾¨ç‡, FP16**: âŒ OOM (éœ€è¦21.5GB)
- **12è§†è§’, 768åˆ†è¾¨ç‡, FP16**: âœ… å¯ç”¨ (~14GB)
- **20è§†è§’, 512åˆ†è¾¨ç‡, FP16**: âœ… å¯ç”¨ (~10GB)

### RTX 4060 Ti (16GB)
- **20è§†è§’, 768åˆ†è¾¨ç‡, FP16**: âŒ OOM
- **12è§†è§’, 512åˆ†è¾¨ç‡, FP16**: âœ… å¯ç”¨ (~7GB)

### RTX 3060 (12GB)
- **20è§†è§’, 768åˆ†è¾¨ç‡, FP16**: âŒ OOM
- **6è§†è§’, 512åˆ†è¾¨ç‡, FP16**: âœ… å¯ç”¨ (~5GB)

---

## æ¨èé…ç½®

### é«˜è´¨é‡ (æ¨è >= 24GB)
```bash
python inference_thg.py \
    --num_inference_steps 50 \
    --guidance_scale 3.0 \
    --thg_interval 3 \
    --use_fp16
```
- 20è§†è§’, 768åˆ†è¾¨ç‡
- æ˜¾å­˜: ~21.5GB
- æ—¶é—´: ~2åˆ†é’Ÿ (RGB+æ³•çº¿)

### ä¸­ç­‰è´¨é‡ (16GB æ˜¾å¡)
```bash
python inference_thg.py \
    --num_inference_steps 50 \
    --guidance_scale 3.0 \
    --thg_interval 3 \
    --use_fp16
# éœ€è¦ä¿®æ”¹ä»£ç è®¾ç½® NUM_VIEWS=12, resolution=512
```
- 12è§†è§’, 512åˆ†è¾¨ç‡
- æ˜¾å­˜: ~8GB
- æ—¶é—´: ~1åˆ†é’Ÿ

### ä½æ˜¾å­˜æ¨¡å¼ (12GB æ˜¾å¡)
```bash
python inference_thg.py \
    --num_inference_steps 30 \
    --guidance_scale 3.0 \
    --thg_interval 4 \
    --use_fp16
# éœ€è¦ä¿®æ”¹ä»£ç è®¾ç½® NUM_VIEWS=6, resolution=512
```
- 6è§†è§’, 512åˆ†è¾¨ç‡
- æ˜¾å­˜: ~5GB
- æ—¶é—´: ~40ç§’

---

## å®é™…æµ‹é‡å»ºè®®

ä¸ºäº†è·å¾—æ›´ç²¾ç¡®çš„æ˜¾å­˜ä½¿ç”¨æ•°æ®ï¼Œå¯ä»¥åœ¨æ¨ç†æ—¶ç›‘æ§ï¼š

```bash
# ç»ˆç«¯1: è¿è¡Œæ¨ç†
python inference_thg.py ...

# ç»ˆç«¯2: å®æ—¶ç›‘æ§æ˜¾å­˜
watch -n 0.5 nvidia-smi --query-gpu=memory.used --format=csv,noheader,nounits
```

æˆ–è€…åœ¨ä»£ç ä¸­æ·»åŠ æ˜¾å­˜ç›‘æ§ï¼š

```python
import torch

def print_gpu_memory():
    if torch.cuda.is_available():
        allocated = torch.cuda.memory_allocated() / 1024**3
        reserved = torch.cuda.memory_reserved() / 1024**3
        print(f"GPU Memory: {allocated:.2f}GB allocated, {reserved:.2f}GB reserved")

# åœ¨å„ä¸ªé˜¶æ®µè°ƒç”¨
print_gpu_memory()
```

---

## æ€»ç»“

**ä½ çš„RTX 4090 (24GB)é…ç½®**:
- âœ… 20è§†è§’ Ã— 768åˆ†è¾¨ç‡: **å®Œå…¨å¤Ÿç”¨** (90%æ˜¾å­˜åˆ©ç”¨ç‡)
- âœ… THGå·²æ­£ç¡®å·¥ä½œï¼ŒèŠ‚çœNFE 33æ¬¡ (49.3%æ•ˆç‡æå‡)
- âœ… æ¨ç†é€Ÿåº¦: RGB 35ç§’, æ³•çº¿ 35ç§’, æ€»è®¡çº¦2åˆ†é’Ÿ
- âš ï¸ å¦‚æœæƒ³æå‡åˆ°1024åˆ†è¾¨ç‡ï¼Œéœ€è¦32GBæ˜¾å­˜ï¼ˆè€ƒè™‘A100æˆ–é™ä½è§†è§’æ•°ï¼‰

**ä¼˜åŒ–æ•ˆæœ**:
- æ ‡å‡†CFG: 100 NFE, çº¦70ç§’/é˜¶æ®µ
- THG (interval=3): 67 NFE, çº¦35ç§’/é˜¶æ®µ, **åŠ é€Ÿ2å€** âš¡
- æ˜¾å­˜: å³°å€¼ä¸å˜(21.5GB), å¹³å‡é™ä½30% (å¹³å‡17GB) ğŸ’¾
